# 本地服务器启动说明

## 问题描述
当前小程序出现 `net::ERR_CONNECTION_REFUSED` 错误，这是因为本地Flask服务器没有启动，导致无法访问上传的文件。

## 解决方案

### 1. 启动Flask服务器

在您的Flask项目目录中运行以下命令：

```bash
# 如果您使用的是Python虚拟环境
python app.py

# 或者
flask run --host=0.0.0.0 --port=80

# 或者指定其他端口（如果80端口被占用）
flask run --host=0.0.0.0 --port=5000
```

### 2. 检查服务器是否正常运行

启动后，您应该看到类似以下的输出：
```
 * Running on http://0.0.0.0:80
 * Debug mode: off
```

### 3. 测试文件访问

在浏览器中访问：`http://127.0.0.1/uploads/` 或 `http://localhost/uploads/`

如果能看到文件列表或返回404（说明路由正常），则表示服务器运行正常。

### 4. 常见问题

#### 端口被占用
如果80端口被占用，可以：
1. 使用其他端口（如5000）
2. 修改小程序中的API配置，将端口改为5000

#### 权限问题
在Windows上可能需要管理员权限才能使用80端口：
1. 以管理员身份运行命令提示符
2. 或者使用其他端口（如5000）

#### 防火墙阻止
确保Windows防火墙允许Python/Flask应用通过。

### 5. 临时解决方案

如果暂时无法启动服务器，小程序会显示相应的错误提示，但基本功能仍然可用。

## 注意事项

- 确保Flask应用中有 `/uploads/<filename>` 路由
- 确保 `uploads` 文件夹存在且有读取权限
- 开发时建议使用 `flask run --debug` 来启用调试模式

## 统一API使用说明

### 文件访问接口统一化

项目中已将所有文件访问接口统一使用 `apiConfig.buildFileUrl()` 方法：

```javascript
const apiConfig = require('../../config/api.js');

// 获取文件访问URL
const fileUrl = apiConfig.buildFileUrl('example.jpg');
// 结果: http://175.178.197.202:80/uploads/example.jpg
```

### 在页面中使用

```javascript
// 在页面JS文件中
const apiConfig = require('../../config/api.js');

// 构建文件URL
const imageUrl = apiConfig.buildFileUrl('project_image_1.jpg');
const videoUrl = apiConfig.buildFileUrl('project_video_1.mp4');
const documentUrl = apiConfig.buildFileUrl('project_document_1.pdf');
```

### 在工具函数中使用

```javascript
// 在utils/fileAccess.js中
const apiConfig = require('../config/api.js');

function buildFileUrl(filename) {
  return apiConfig.buildFileUrl(filename);
}
```

### 优势

1. **统一管理**: 所有文件访问URL都通过 `api.js` 统一管理
2. **环境切换**: 可以轻松切换开发、测试、生产环境
3. **维护性**: 修改服务器地址时只需修改 `api.js` 文件
4. **一致性**: 所有页面使用相同的文件访问方式

## 文档预览说明

### PDF/DOCX文件预览

根据微信小程序的限制，PDF和DOCX文件无法直接在线预览，需要采用以下方式：

```javascript
// 示例流程(下载+打开文档)
wx.downloadFile({
  url: 'https://yourdomain.com/uploads/test.pdf',
  success(res) {
    wx.openDocument({
      filePath: res.tempFilePath
    })
  }
})
```

### 实现要点

1. **下载到本地**: 使用 `wx.downloadFile` 将文件下载到本地临时文件
2. **本地打开**: 使用 `wx.openDocument` 打开本地文件
3. **文件类型支持**: `openDocument` 要求文件类型受支持(pdf、docx等)且文件已经下载到本地
4. **统一处理**: 所有文档预览都使用相同的下载+打开流程

### 错误处理

- **下载超时**: 提示"下载超时，请检查网络连接"
- **服务器连接失败**: 提示"服务器连接失败，请检查服务器状态"
- **下载被中断**: 提示"下载被中断"
- **文件打开失败**: 提示"无法预览此文件"
