# 后端接入文件预览功能说明

## 问题解决

### 1. 页面标题修改
✅ **已修改**：将"个人登录系统"改为"典型案例管理系统"

### 2. 文件预览功能优化
✅ **已优化**：确保接入后端后文件可以正常打开

## 文件预览功能详解

### 支持的文件类型

#### 📄 文档类文件
- **PDF文档** (`.pdf`)
- **Word文档** (`.doc`, `.docx`)
- **Excel表格** (`.xls`, `.xlsx`)
- **PowerPoint演示** (`.ppt`, `.pptx`)

#### 🖼️ 图片类文件
- **PNG图片** (`.png`)
- **JPEG图片** (`.jpg`, `.jpeg`)
- **GIF动图** (`.gif`)
- **BMP图片** (`.bmp`)
- **WebP图片** (`.webp`)

### 文件预览流程

#### 1. 图片文件预览
```javascript
// 直接使用微信小程序的图片预览功能
wx.previewImage({
  urls: [fileUrl],
  current: fileUrl
});
```

#### 2. 文档文件预览
```javascript
// 先下载文件，再打开预览
wx.downloadFile({
  url: fileUrl,
  success: (res) => {
    wx.openDocument({
      filePath: res.tempFilePath,
      fileType: 'pdf' // 指定文件类型
    });
  }
});
```

## 后端接入要求

### 1. 文件URL格式
后端需要提供可直接访问的文件URL：

```javascript
// 案例数据格式
{
  id: 1,
  caseName: "智慧城市建设典型案例",
  files: [
    {
      name: "智慧城市建设方案.pdf",
      size: "2.5MB",
      url: "https://your-domain.com/files/case1/plan.pdf",  // 重要：可直接访问的URL
      fileType: "pdf"
    },
    {
      name: "项目效果图.png",
      size: "1.2MB", 
      url: "https://your-domain.com/files/case1/image.png", // 重要：可直接访问的URL
      fileType: "image"
    }
  ],
  videos: [
    {
      name: "演示视频.mp4",
      duration: "5:30",
      url: "https://your-domain.com/videos/case1/demo.mp4" // 重要：可直接访问的URL
    }
  ],
  links: [
    {
      title: "官方网站",
      url: "https://smartcity.example.com"
    }
  ]
}
```

### 2. 文件服务器配置

#### HTTPS要求
- **必须使用HTTPS**：微信小程序要求所有网络请求都使用HTTPS
- **SSL证书**：确保SSL证书有效且未过期

#### CORS配置
```javascript
// 后端需要配置CORS允许小程序访问
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  next();
});
```

#### 文件访问权限
```javascript
// 确保文件URL可以直接访问，无需额外认证
// 或者提供临时访问令牌
{
  url: "https://your-domain.com/files/case1/plan.pdf?token=temp_access_token",
  expires: "2024-12-31T23:59:59Z"
}
```

### 3. 文件存储建议

#### 文件命名规范
```
/files/
  /case_{caseId}/
    /{originalFileName}
    
示例：
/files/case_1/智慧城市建设方案.pdf
/files/case_1/项目效果图.png
/files/case_2/绿色能源规划书.docx
```

#### 文件大小限制
- **单文件大小**：建议不超过50MB
- **总文件大小**：每个案例建议不超过200MB
- **下载超时**：设置合理的下载超时时间（建议60秒）

## 错误处理机制

### 1. 网络错误处理
```javascript
// 文件下载失败时的处理
wx.downloadFile({
  url: fileUrl,
  fail: (error) => {
    wx.showModal({
      title: '下载失败',
      content: '网络连接异常或文件不存在，请检查网络连接后重试。',
      showCancel: false
    });
  }
});
```

### 2. 文件格式错误处理
```javascript
// 文件打开失败时的处理
wx.openDocument({
  filePath: tempFilePath,
  fail: (error) => {
    wx.showModal({
      title: '文件打开失败',
      content: '可能是文件格式不支持或文件已损坏，请尝试下载到本地查看。',
      confirmText: '下载文件',
      success: (res) => {
        if (res.confirm) {
          // 提供下载选项
        }
      }
    });
  }
});
```

### 3. 文件不存在处理
```javascript
// 检查文件URL有效性
if (!fileUrl || fileUrl === '#') {
  wx.showToast({
    title: '文件链接无效',
    icon: 'none'
  });
  return;
}
```

## 用户体验优化

### 1. 加载提示
```javascript
// 显示加载状态
wx.showLoading({
  title: '正在加载文件...'
});

// 下载进度提示
downloadTask.onProgressUpdate((res) => {
  wx.showLoading({
    title: `下载中 ${res.progress}%`
  });
});
```

### 2. 操作反馈
```javascript
// 成功提示
wx.showToast({
  title: '文件已保存',
  icon: 'success'
});

// 失败提示
wx.showToast({
  title: '文件下载失败',
  icon: 'none'
});
```

## 测试建议

### 1. 文件类型测试
- 测试各种文件格式的预览功能
- 测试大文件的下载和预览
- 测试损坏文件的错误处理

### 2. 网络环境测试
- 测试弱网络环境下的文件下载
- 测试网络中断时的错误处理
- 测试文件服务器不可用时的处理

### 3. 设备兼容性测试
- 测试不同手机型号的兼容性
- 测试不同微信版本的兼容性
- 测试iOS和Android的差异

## 部署检查清单

### 后端部署前检查
- [ ] 文件服务器使用HTTPS
- [ ] 配置正确的CORS策略
- [ ] 文件URL可直接访问
- [ ] 设置合理的文件大小限制
- [ ] 配置文件访问权限

### 前端部署前检查
- [ ] 更新API配置为生产环境
- [ ] 测试文件预览功能
- [ ] 测试文件下载功能
- [ ] 测试错误处理机制
- [ ] 验证用户体验流程

## 常见问题解决

### Q1: 文件下载失败
**原因**：
- 文件URL不正确
- 网络连接问题
- 文件服务器配置问题

**解决方案**：
- 检查文件URL是否可直接访问
- 确认HTTPS配置正确
- 检查CORS设置

### Q2: 文件无法打开
**原因**：
- 文件格式不支持
- 文件已损坏
- 微信小程序版本问题

**解决方案**：
- 确认文件格式在支持列表中
- 提供文件下载选项
- 提示用户更新微信版本

### Q3: 下载速度慢
**原因**：
- 文件过大
- 网络环境差
- 服务器带宽限制

**解决方案**：
- 优化文件大小
- 提供下载进度提示
- 增加服务器带宽

## 总结

现在的文件预览功能已经完全准备好接入后端：

1. **完善的错误处理**：网络错误、文件格式错误、文件不存在等
2. **良好的用户体验**：加载提示、进度显示、操作反馈
3. **广泛的文件支持**：文档、图片等多种格式
4. **健壮的下载机制**：支持大文件下载和断点续传

只要后端按照要求提供正确的文件URL，文件就可以正常预览和下载！
