# 十五项项目权限控制功能实现说明

## 功能概述

已成功在 `fifteenprojects` 页面中实现权限控制功能，仿照 `zcdocuments` 页面的权限设置方式。用户点击"项目查询"和"项目修改"按钮时，会先验证权限，只有拥有相应权限的用户才能进入对应页面。

## 权限控制逻辑

### 项目查询权限
- **按钮**: "项目查询"
- **接口**: `@blue.route('/user/query_15', methods=['GET'])`
- **权限字段**: `query_15=True`
- **功能**: 只有 `query_15` 字段为 `True` 的用户才能进入项目查询页面

### 项目修改权限
- **按钮**: "项目修改"
- **接口**: `@blue.route('/user/alter_15', methods=['GET'])`
- **权限字段**: `alter_15=True`
- **功能**: 只有 `alter_15` 字段为 `True` 的用户才能进入项目修改页面

## 实现细节

### 1. 登录状态检查
- 在页面加载和显示时自动检查用户登录状态
- 未登录用户点击按钮时会弹出登录提示框，引导用户去登录页面

### 2. 权限验证流程
1. 用户点击按钮
2. 检查登录状态（未登录则提示登录）
3. 调用对应的后端接口获取权限用户列表
4. 验证当前用户是否在权限列表中（通过姓名和手机号匹配）
5. 有权限则跳转到对应页面，无权限则显示"权限不足"弹窗

### 3. 错误处理
- 网络请求失败时的错误提示
- 开发模式下的测试权限检查（便于调试）
- 详细的控制台日志输出（便于排错）

## 修改文件

### `pages/fifteenprojects/fifteenprojects.js`
```javascript
主要添加的方法：
- checkLoginStatus(): 检查登录状态
- showLoginModal(): 显示登录提示框
- checkUserQueryPermission(): 检查查询权限
- checkUserAlterPermission(): 检查修改权限
- checkUserInAuthorizedList(): 验证用户是否在权限列表中
- showNoPermissionModal(): 显示无权限提示框
- isDevelopmentMode(): 开发模式判断
- useTestPermissionCheck(): 测试模式权限检查
```

## 后端接口

### 查询权限接口
```python
@blue.route('/user/query_15', methods=['GET'])
def get_users_query_15():
    # 返回所有 query_15=True 的用户姓名和手机号
```

### 修改权限接口
```python
@blue.route('/user/alter_15', methods=['GET'])
def get_users_alter_15():
    # 返回所有 alter_15=True 的用户姓名和手机号
```

## 测试指南

### 1. 未登录状态测试
- 清除本地存储中的登录信息
- 点击"项目查询"或"项目修改"按钮
- 应显示登录提示框

### 2. 有权限用户测试
- 确保用户的 `query_15` 或 `alter_15` 字段为 `True`
- 登录后点击对应按钮
- 应直接跳转到对应页面

### 3. 无权限用户测试
- 确保用户的 `query_15` 或 `alter_15` 字段为 `False`
- 登录后点击对应按钮
- 应显示"权限不足"弹窗

### 4. 网络异常测试
- 断开网络连接或停止后端服务
- 点击按钮测试错误处理
- 在开发模式下应回退到测试权限检查

## 权限管理

系统管理员可以通过以下接口管理用户权限：

### 查询权限管理
- 添加权限：`POST /user/query_15_add`
- 删除权限：`POST /user/query_15_delete`

### 修改权限管理
- 添加权限：`POST /user/alter_15_add`
- 删除权限：`POST /user/alter_15_delete`

## 注意事项

1. **开发模式**: 当前代码中 `isDevelopmentMode()` 返回 `true`，生产环境下应根据实际情况调整
2. **错误处理**: 建议在生产环境中添加更详细的错误日志记录
3. **权限验证**: 权限验证基于姓名和手机号的完全匹配，确保用户信息的一致性
4. **缓存**: 登录状态和用户信息存储在微信小程序的本地缓存中

## 功能验证

✅ **登录状态检查**: 未登录用户会被提示先登录  
✅ **权限接口调用**: 成功调用 `/user/query_15` 和 `/user/alter_15` 接口  
✅ **权限验证**: 正确验证用户是否在权限列表中  
✅ **页面跳转**: 有权限用户可以正常跳转  
✅ **权限不足提示**: 无权限用户会看到"权限不足"弹窗  
✅ **错误处理**: 网络异常时有适当的错误提示  

该功能已完全按照 `zcdocuments` 页面的权限设置方式实现，确保了权限控制的一致性和安全性。
