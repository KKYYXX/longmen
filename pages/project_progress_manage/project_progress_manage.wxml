<view class="manage-container">
  <view class="texture-overlay"></view>
  <view class="light-spot"></view>
  
  <!-- 头部导航 -->
  <view class="header">
    <view class="back-btn" bindtap="navigateBack">
      <text class="back-icon">←</text>
    </view>
    <view class="title-box">
      <text class="title">项目进度管理</text>
      <text class="subtitle">{{selectedProject ? selectedProject.projectName : '选择项目'}}</text>
    </view>
    <view class="action-btn" wx:if="{{selectedProject}}" bindtap="showAddForm">
      <text class="action-icon">➕</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 项目选择列表 -->
  <view class="project-list" wx:if="{{!selectedProject && !loading}}">
    <view class="section-header">
      <text class="section-title">📋 选择要管理的项目</text>
      <text class="section-subtitle">点击项目查看和管理进度</text>
    </view>
    
    <view class="project-grid">
      <view 
        class="project-card" 
        wx:for="{{projectList}}" 
        wx:key="id"
        bindtap="selectProject"
        data-project="{{item}}"
      >
        <view class="project-info">
          <text class="project-name">{{item.projectName}}</text>
          <text class="project-type">{{item.projectType}}</text>
        </view>
        <view class="project-arrow">→</view>
      </view>
    </view>
  </view>

  <!-- 进度管理界面 -->
  <view class="progress-manage" wx:if="{{selectedProject && !loading}}">
    <view class="project-header">
      <view class="back-project-btn" bindtap="backToProjectList">
        <text class="back-icon">←</text>
      </view>
      <view class="project-info">
        <text class="project-name">{{selectedProject.projectName}}</text>
        <text class="project-type">{{selectedProject.projectType}}</text>
      </view>
    </view>

    <!-- 进度列表 -->
    <view class="progress-list">
      <view class="list-header">
        <text class="list-title">📈 项目进度记录</text>
        <text class="list-count">共 {{progressList.length}} 条记录</text>
      </view>

      <view class="progress-items">
        <view 
          class="progress-item" 
          wx:for="{{progressList}}" 
          wx:key="id"
        >
          <view class="progress-content">
            <view class="progress-header">
              <text class="progress-title">{{item.title}}</text>
              <text class="progress-status {{item.status}}">{{item.statusText}}</text>
            </view>
            
            <view class="progress-details">
              <view class="detail-row">
                <text class="detail-label">📅 时间：</text>
                <text class="detail-value">{{item.date}} {{item.time}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">📍 地点：</text>
                <text class="detail-value">{{item.location}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">👤 负责人：</text>
                <text class="detail-value">{{item.person}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">📝 描述：</text>
                <text class="detail-value">{{item.description}}</text>
              </view>
            </view>

            <!-- 完成度 -->
            <view class="completion-info" wx:if="{{item.completion}}">
              <text class="completion-label">完成度：</text>
              <view class="completion-bar">
                <view class="completion-fill" style="width: {{item.completion}}%"></view>
              </view>
              <text class="completion-text">{{item.completion}}%</text>
            </view>
          </view>

          <view class="progress-actions">
            <view class="action-btn edit-btn" bindtap="editProgress" data-progress="{{item}}">
              <text class="action-icon">✏️</text>
            </view>
            <view class="action-btn delete-btn" bindtap="deleteProgress" data-progress="{{item}}">
              <text class="action-icon">🗑️</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 空状态 -->
      <view class="empty-progress" wx:if="{{progressList.length === 0}}">
        <text class="empty-icon">📈</text>
        <text class="empty-text">暂无进度记录</text>
        <text class="empty-hint">点击右上角 ➕ 添加进度记录</text>
      </view>
    </view>
  </view>

  <!-- 添加/编辑表单 -->
  <view class="form-overlay" wx:if="{{showAddForm}}" bindtap="hideForm">
    <view class="form-container" catchtap="">
      <view class="form-header">
        <text class="form-title">{{editingProgress ? '编辑' : '添加'}}进度记录</text>
        <view class="close-btn" bindtap="hideForm">
          <text class="close-icon">✕</text>
        </view>
      </view>

      <view class="form-content">
        <view class="form-group">
          <text class="form-label">日期</text>
          <picker mode="date" value="{{formData.date}}" bindchange="onDateChange">
            <view class="form-input picker-input">
              <text>{{formData.date || '选择日期'}}</text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">时间</text>
          <picker mode="time" value="{{formData.time}}" bindchange="onTimeChange">
            <view class="form-input picker-input">
              <text>{{formData.time || '选择时间'}}</text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">标题</text>
          <input 
            class="form-input" 
            placeholder="请输入进度标题"
            value="{{formData.title}}"
            bindinput="onFormInput"
            data-field="title"
          />
        </view>

        <view class="form-group">
          <text class="form-label">地点</text>
          <input 
            class="form-input" 
            placeholder="请输入地点"
            value="{{formData.location}}"
            bindinput="onFormInput"
            data-field="location"
          />
        </view>

        <view class="form-group">
          <text class="form-label">负责人</text>
          <input 
            class="form-input" 
            placeholder="请输入负责人"
            value="{{formData.person}}"
            bindinput="onFormInput"
            data-field="person"
          />
        </view>

        <view class="form-group">
          <text class="form-label">状态</text>
          <picker range="{{['待开始', '进行中', '已完成']}}" bindchange="onStatusChange">
            <view class="form-input picker-input">
              <text>{{formData.status === 'pending' ? '待开始' : formData.status === 'ongoing' ? '进行中' : '已完成'}}</text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">完成度：{{formData.completion}}%</text>
          <slider 
            value="{{formData.completion}}" 
            min="0" 
            max="100" 
            step="5"
            bindchange="onCompletionChange"
            activeColor="#007AFF"
            backgroundColor="#E5E5E5"
          />
        </view>

        <view class="form-group">
          <text class="form-label">描述</text>
          <textarea 
            class="form-textarea" 
            placeholder="请输入详细描述"
            value="{{formData.description}}"
            bindinput="onFormInput"
            data-field="description"
            maxlength="500"
          />
        </view>
      </view>

      <view class="form-actions">
        <view class="form-btn cancel-btn" bindtap="hideForm">
          <text>取消</text>
        </view>
        <view class="form-btn save-btn" bindtap="saveProgress">
          <text>{{editingProgress ? '保存' : '添加'}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
